<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
<head>
    <title></title>
    <meta charset="utf-8">
    <meta name="viewport"
          content="target-densitydpi=device-dpi,  width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <!-- <link rel="stylesheet" href="../../css/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="../../css/ui-box.css">
    <link rel="stylesheet" href="../../css/ui-base.css">
    <link rel="stylesheet" href="../../css/ui-color.css">
    <link rel="stylesheet" href="../../css/appcan.icon.css">
    <link rel="stylesheet" href="../../css/appcan.control.css"> -->
    
    <link rel="stylesheet" type="text/css" href="../../css/public.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/iconfont/iconfont.css">
    <link rel="stylesheet" type="text/css" href="../../css/logbook.css"/>
    <link rel="stylesheet" type="text/css" href="../../js/pictureUpload/css/IMGUP.css"/>
    <style>
        input, select, textarea {
             background-color: #f4f4f4;
        }
    </style>
</head>
<body class="body">
    <div id="ScrollContent">
        <div id="codemapDetail">
        <!-- 隐藏信息 -->
        <div style="display: none" id="hide_col">
            <input id="deviceID" name="deviceID" type="text" class="ub-f1 gsoft-value">
            <input id="businessID" name="businessID" type="text" class="ub-f1 gsoft-value">
            <input id="flowNo" name="flowNo" type="text" class="ub-f1 gsoft-value">
            <input id="apprType" name="apprType" type="text" class="ub-f1 ">
        </div>
        <!-- 基础信息 -->
        <div class="block">
            <div class="block-head text-black">
                <span class="block-title">基础信息</span>
            </div>
            <div class='block-body'>
                <table class="table-input">
                    <tr>
                        <td style="width:5em;"><span class="input-label">机车选择:</span></td>
                        <td style="width:calc(100% -5em);"><input id="device" name="deviceNo" type="text" class="gsoft-value input-text" readonly="true"></td>
                    </tr>
                    <tr>
                        <td><span class="input-label">维保类型:</span></td>
                        <td><select selectedindex="0" id="mType" name="mType" class="gsoft-value input-text" disabled="true">
                            <option value=1>日常检查</option>
                            <option value=2>周期保养</option>
                            <option value=3>临时维修</option>
                            <option value=4>重点大修</option>
                        </select></td>
                    </tr>
                </table>
            </div>
        </div>
        <!-- 维保审批:设备信息 -->
        <div class="block">
            <div class="block-head text-black">
                <span class="block-title">设备信息</span>
            </div>
            <div class="block-body">
                <table class="table-input">
                    <tr>
                        <td style="width:5em;"><span class="input-label">设备名称:</span></td>
                        <td style="width:calc(50% -5em);"><input id="deviceName" name="deviceName" type="text" class="gsoft-value input-text" readonly="true"></td>
                        <td style="width:5em;"><span class="input-label">累计里程:</span></td>
                        <td style="width:calc(50% -5em);"><input id="sumRunKms" name="sumRunKms" type="text" class="gsoft-value input-text" readonly="true"></td>
                        
                    </tr>
                    <tr>
                        <td><span class="input-label">设备编号:</span></td>
                        <td><input id="deviceNo" name="deviceNo" type="text" class="gsoft-value input-text" readonly="true" /></span></td>
                        <td><span class="input-label">累计时间:</span></td>
                        <td><input id="sumRunHours" name="sumRunHours" type="text" class="gsoft-value input-text" readonly="true"></td>
                    </tr>
					<tr>
                        <td><span class="input-label text_necessary">维保部位:</span></td>
                        <td><select selectedindex="0" id="repairPartType" name="repairPartType" class="gsoft-value input-text" disabled="true">
                                <option value=1>整车</option>
                                <option value=2>零部件</option>
                            </select>
                        </td>
                    </tr>
                    <tr id="tr_repair">
                        <td><span class="input-label text_necessary">维保零部件:</span></td>
                            <td><select selectedindex="0" id="repairPartID" name="repairPartID" class="gsoft-value input-text" disabled="true">
                            </select></td>
                            <td><span class="input-label text_necessary">维修/更换</span></td>
                            <td><select selectedindex="0" id="repairReplace" name="repairReplace" class="gsoft-value input-text" disabled="true">
                                <option value=1>维修</option>
                                <option value=2>更换</option>
                            </select></td>
                        </tr>
                    <tr>
                        <td><span class="input-label">规格类型:</span></td>
                        <td><input id="stdModel" name="stdModel" type="text" class="gsoft-value input-text" readonly="true"></td>
                        <td id="tr_repair_rType"><span class="input-label">修别:</span></td>
                        <td id="tr_repair_rType2"><select selectedindex="0" id="rType" name="rType" class="gsoft-value input-text" disabled="true">
                            <option value=1>车轴探伤</option>
                            <option value=2>车钩探伤</option>
                            <option value=3>制动校验</option>
                            <option value=4>换季保养</option>
                        </select></td>
                    </tr>
                    <tr>
                        <td id="tr_maintenance_unit"><span class="input-label">承修单位:</span></td>
                        <td id="tr_maintenance_unit2"><select selectedindex="0" id="company" name="company" class="gsoft-value input-text" disabled="true" >
                        </select></td>
                        <td id="tr_tmp_type"><span class="input-label">临修类型:</span></td>
                        <td id="tr_tmp_type2"><select selectedindex="0" id="tmpType" name="tmpType" class="gsoft-value input-text" disabled="true">
                            <option value=1>维外</option>
                            <option value=2>自修</option>
                        </select></td>
                    </tr>
                    <tr>
                        <td valign="top"><span id="div_reanson" class="input-label">原因:</span></td>
                        <td colspan="3"><textarea id="reason" name="reason" readonly="true" class="gsoft-value input-textarea" rows="3"></textarea></td>
                    </tr>
                </table>
            </div>
            <div id="pic_upload" class="block-foot">
                <table class="table-input">
                    <tr>
                        <td style="width:5em;"><span class="input-label">维保申请<br />照片:</span></td>
                        <td style="width:calc(100% -5em);">
                            <div class="div_download">
                                <div class="div_imglook">
                                    <div id="downloadPicture" class="lookimg bor-0">
                                        <img src="../../img/photo-active.png">
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        </div>
        <!-- 审批信息 -->
        <div id="appr_info" class="block">
            <div class="block-head text-black">
                <span class="block-title">审批信息</span>
            </div>
            <div class="block-body">
                <table class="table-input">
                    
                    <tr>
                        <td><span id="chooseUser" class="input-label">下一步审批人:</span></td>
                        <td><select selectedindex="0" id="check_user" class="gsoft-value input-text"></select></td>
                    </tr>
                </table>
            </div>
        </div>
        <!-- 确认按钮 -->
        <div class="btn-group">
            <button id="nopass" class="btn btn-no">不同意</button><button id="pass" class="btn">同意</button>
        </div>
    </div>
<script src="../../js/appcan.js"></script>
<script src="../../js/appcan.control.js"></script>
<script src="../../js/gsoft.core.js"></script>
<script src="../../js/pictureUpload/jquery-1.7.2.min.js"></script>
    <script src="../../js/public.js"></script>
<script src="../../js/pictureUpload/IMGUP.js"></script>
<script src="../../js/pictureUpload/pictrueUpload.js"></script>
</body>
<script>
    var public = new Public();
    public.header('维保审批',true,true);//显示顶部:标题名，左侧icon，右侧icon
    public.footer();//显示底部
    public.backBtn();
    
    appcan.ready(function () {
        loadUsers();
        
        var pageParams = appcan.gsoft.parameterUtils.getPageParams();
        var apprStatus = pageParams.apprStatus;
        loadEngineParts(pageParams.deviceID,pageParams.repairPartID);
        loadMaintenanceUnit(pageParams.company);//加载维修单位
        //alert(JSON.stringify(pageParams));
        if(apprStatus==2){
            //$("#chooseUser").hide();
            //$("#check_user").hide();
            $("#appr_info").hide();
        }
        //下载图片
        var flowNo = pageParams.flowNo;
        downloadMobileFile(flowNo,"1","div_download");
        
        if (pageParams) {
            appcan.gsoft.recordUtils.fillInputRecord($('#codemapDetail'), pageParams);
        }
        
        var mtype = pageParams.mType;
        judgeApprType(apprStatus);
        mtype_change(mtype);
        
    });
    
    /**
     * 加载审核人
     */
    function loadUsers() {
        $("#appr_info").hide();
        appcan.gsoft.ajaxUtil.ajax({
            url: "/gltlUserManager/getDirectLeader.json",
            data: "",
            success: function (data) {
                var users = data.records;
                for (var i = 0; i < users.length; i++) {
                    var op = '<option value=' + users[i].userId + '>' + users[i].fUname + '</option>';
                    $("#check_user").append(op);
                }
            }
        });
    }
    
    /**
     * 加载维修单位
     */
    function loadMaintenanceUnit(company) {
        appcan.gsoft.ajaxUtil.ajax({
            url: "/codemapManager/getConvert.json",
            data: "name=maintenance_unit",
            success: function (data) {
                //alert(JSON.stringify(data.record));
                var units = data.record;
                for (key in units) {
                    if (units.hasOwnProperty(key)){
                        var op = '<option value=' + key + '>' + units[key] + '</option>';
                        $("#company").append(op);
                    }
                }
                $("#company").val(company);
            }
        });
    }
    
    /**
     * 加载机车部件
     */
    function loadEngineParts(fEid,repairPartID) {
        appcan.gsoft.ajaxUtil.ajax({
            url: "/GltlEnginepartsManager/getGltlEnginepartsByEid.json",
            data: "fEid="+fEid,
            success: function (data) {
                //alert(JSON.stringify(data.record));
                var parts = data.records;
                if(parts){
                    for (var i = 0; i < parts.length; i++) {
                        var op = '<option value=' + parts[i].fEpid + '>' + parts[i].fEpname + '</option>';
                        $("#repairPartID").append(op);
                    }
                }
                $("#repairPartID").val(repairPartID);
            }
        });
    }
    
    /**
     *判断审批类型 
     */
    function judgeApprType(status){
        appcan.gsoft.ajaxUtil.ajax({
            url: "/eMainTainManager/getApprType.json",
            data: "id="+status,
            success: function (data) {
                $("#apprType").val(data.record.html)
            }
        });
    }
    
    
    /**
     * 临修维修类型监听
     */
    function tmptype_change() {
        var type = $("#tmpType").val();
        switch (parseInt(type)) {
            case 1:
                $("#tr_maintenance_unit").show();
                break;
            case 2:
                $("#tr_maintenance_unit").hide();
                break;
        }

    }
    
    /**
     * 维保部位监听
     */
    function reparttype_change() {
        var type = $("#repairPartType").val();
        switch (parseInt(type)) {
            case 1:
                $("#tr_repair").hide();
                break;
            case 2:
                $("#tr_repair").show();
                break;
        }

    }
    
    /**
     * 维保类型监听
     */
    function mtype_change(mtype) {
        //alert(parseInt(mtype));
        switch (parseInt(mtype)) {
            case 1:
                $("#div_reanson").hide();
                $("#reason").hide();
                $("#tr_repair_rType").hide();
                $("#pic_upload").hide();
                break;
            case 2:
                $(".input-label").attr('class','input-label');
                $('#downloadPicture').hide();
                $("#div_reanson").hide();
                $("#reason").hide();
                $("#tr_repair_rType").hide();
                $("#tr_repair_rType2").hide();
                $("#pic_upload").hide();
                $("#tr_tmp_type").hide();
                $("#tr_tmp_type2").hide();
                $("#tr_maintenance_unit").show();
                reparttype_change();
                break;
            case 3:
                $(".input-label").attr('class','input-label');
                $('#downloadPicture').hide();
                $("#div_reanson").show();
                $("#reason").show();
                $("#tr_repair_rType").show();
                $("#tr_repair_rType2").show();
                $("#pic_upload").show();
                $("#tr_tmp_type").show();
                $("#tr_tmp_type2").show();
                tmptype_change();
                reparttype_change();
                break;
            case 4:
                $(".input-label").attr('class','input-label');
                $('#downloadPicture').hide();
                $("#div_reanson").hide();
                $("#reason").hide();
                $("#tr_repair_rType").show();
                $("#tr_repair_rType2").show();
                $("#tr_tmp_type").hide();
                $("#tr_tmp_type2").hide();
                $("#pic_upload").hide();
                $("#tr_maintenance_unit").show();
                reparttype_change();
                break;
        }

    }
    /**
     *同意审批
     */
    var passFlag = true;
    appcan.button("#pass", "ani-act", function () {
        var businessID = $("#businessID").val();
        var engineID = $("#deviceID").val();
        var flowNo = $("#flowNo").val();
        var mType = $("#mType").val();
        var flowReceiver = $("#check_user").val();
        var apprType = $("#apprType").val();
        if(passFlag){
            appcan.gsoft.ajaxUtil.ajax({
                url: "/eMainTainManager/approveEMainTain.json",
                data: "businessID=" + businessID + "&flowNo=" + flowNo + "&mType=" + mType + "&apprType=" + apprType + "&isAgree=1&flowReceiver=" + flowReceiver + "&engineID=" + engineID,
                success: function (data) {
                    var record = data.record;
                    if(record){
                        var code = record.code;
                        if(code == '000000'){
                            appcan.window.confirm({
                                title:'提示',
                                content:'审批成功',
                                buttons:['确定'],
                                callback:function(err,data,dataType,optId){
                                    if(err){return; }
                                    //关闭当前窗口
                                   appcan.window.close(-1);
                                   passFlag = true;
                                }
                            });
                        }else{
                            appcan.window.alert({
                                title: '提示',
                                content: record.message,
                                buttons: '确定'
                            });
                            passFlag = true;
                        }
                    }
                    
                }
            });
            passFlag = false;
        }
    });
    /**
     *不同意审批
     */
    var nopassFlag = true;
    appcan.button("#nopass", "ani-act", function () {
        var businessID = $("#businessID").val();
        var engineID = $("#deviceID").val();
        var flowNo = $("#flowNo").val();
        var mType = $("#mType").val();
        var flowReceiver = $("#check_user").val();
        var apprType = $("#apprType").val();
        if(nopassFlag){
            appcan.gsoft.ajaxUtil.ajax({
                url: "/eMainTainManager/approveEMainTain.json",
                data: "businessID=" + businessID + "&flowNo=" + flowNo + "&mType=" + mType + "&apprType=" + apprType + "&isAgree=0&flowReceiver=" + flowReceiver + "&engineID=" + engineID,
                success: function (data) {
                    var record = data.record;
                    if(record){
                        var code = record.code;
                        if(code == '000000'){
                            appcan.window.confirm({
                                title:'提示',
                                content:'审批不同意成功',
                                buttons:['确定'],
                                callback:function(err,data,dataType,optId){
                                    if(err){return; }
                                    //关闭当前窗口
                                   appcan.window.close(-1);
                                   nopassFlag = true;
                                }
                            });
                        }else{
                            appcan.window.alert({
                                title: '提示',
                                content: record.message,
                                buttons: '确定'
                            });
                            nopassFlag = true;
                        }
                    }
                }
            });
            nopassFlag = false;
        }

    });

</script>
</html>